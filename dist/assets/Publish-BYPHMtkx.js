import{_ as e,r as a,m as l,g as t,a as s,n as i,C as r,u as n,c as o,o as u,b as c,l as d,t as p,w as v,x as m,F as g,z as f,e as y,v as h,D as b,E as k}from"./index-DgsTEpUf.js";import{a as x,c as w,e as I}from"./product-DTdrY-bL.js";import{g as C}from"./verification-B-_pL_qt.js";import{a as q}from"./request-DczqgLPf.js";const _={class:"publish-page"},B={class:"navbar"},j={class:"nav-container"},S={class:"nav-brand"},U={class:"main-content"},V={class:"form-section"},T={class:"images-grid"},z=["src"],A=["onClick"],D={key:0,class:"cover-tag"},F={class:"form-section"},M={class:"form-group"},E={class:"form-row"},H={class:"form-group"},J={class:"price-input"},N={class:"form-group"},O={class:"form-group"},P=["disabled"],$={key:0,class:"spinner"},G={key:1},K=e({__name:"Publish",setup(e){const K=n(),L=t(),Q=a(null),R=a(!1),W=a(!1),X=a([]),Y=a(!1),Z=l(()=>JSON.parse(localStorage.getItem("userInfo")||"{}")),ee=l(()=>!!L.query.id),ae=l(()=>L.query.id),le=s({title:"",price:null,categoryId:"",description:""});i(async()=>{var e;try{if(1!==(null==(e=(await C()).data)?void 0:e.status))return void r.confirm("发布商品需要先完成实名认证，认证后可享受完整交易功能","需要实名认证",{confirmButtonText:"去认证",cancelButtonText:"返回"}).then(()=>K.push("/real-name-verify")).catch(()=>K.back());Y.value=!0}catch(a){}ee.value&&(async()=>{if(ae.value)try{const e=(await x(ae.value)).data;le.title=e.title,le.price=e.price,le.categoryId=e.categoryId,le.description=e.description,e.images?X.value=e.images.split(",").filter(e=>e):e.mainImage&&(X.value=[e.mainImage])}catch(a){a._handled||k.error("加载商品信息失败")}})()});const te=()=>{var e;return null==(e=Q.value)?void 0:e.click()},se=async e=>{const a=Array.from(e.target.files);if(!a.length)return;const l=9-X.value.length,t=a.slice(0,l);W.value=!0;for(const i of t){const e=new FormData;e.append("file",i);try{const a=await q.post("/api/file/upload",e,{headers:{"Content-Type":"multipart/form-data",Authorization:"Bearer "+localStorage.getItem("token")}});200===a.data.code?X.value.push(a.data.data):k.error(a.data.message||"上传失败")}catch(s){k.error("上传失败")}}W.value=!1,e.target.value=""},ie=async()=>{if(0!==X.value.length){R.value=!0;try{const e={...le,mainImage:X.value[0],images:X.value.join(",")};ee.value?(await w({...e,id:ae.value}),k.success("修改成功")):(await I({...e,sellerId:Z.value.id}),k.success("发布成功")),K.push("/profile")}catch(e){e._handled||k.error(e.message||(ee.value?"修改失败":"发布失败"))}finally{R.value=!1}}else k.warning("请上传至少一张商品图片")};return(e,a)=>(u(),o("div",_,[c("nav",B,[c("div",j,[c("button",{class:"btn-back",onClick:a[0]||(a[0]=a=>e.$router.back())},[...a[5]||(a[5]=[c("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[c("path",{d:"M19 12H5M12 19l-7-7 7-7"})],-1),d(" 返回 ",-1)])]),c("div",S,p(ee.value?"编辑商品":"发布商品"),1)])]),c("main",U,[c("form",{onSubmit:v(ie,["prevent"]),class:"publish-form"},[c("div",V,[a[9]||(a[9]=c("h3",null,[d("商品图片 "),c("span",{class:"hint"},"（最多9张，第一张为封面）")],-1)),c("div",T,[(u(!0),o(g,null,f(X.value,(e,l)=>(u(),o("div",{key:l,class:"image-item"},[c("img",{src:e,class:"preview-image"},null,8,z),c("button",{type:"button",class:"btn-remove",onClick:e=>(e=>{X.value.splice(e,1)})(l)},[...a[6]||(a[6]=[c("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[c("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),c("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,A),0===l?(u(),o("span",D,"封面")):m("",!0)]))),128)),X.value.length<9?(u(),o("div",{key:0,class:"upload-area",onClick:te},[c("input",{ref_key:"fileInput",ref:Q,type:"file",accept:"image/*",multiple:"",onChange:se,hidden:""},null,544),a[7]||(a[7]=c("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[c("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),c("line",{x1:"5",y1:"12",x2:"19",y2:"12"})],-1)),a[8]||(a[8]=c("span",null,"添加图片",-1))])):m("",!0)])]),c("div",F,[a[16]||(a[16]=c("h3",null,"商品信息",-1)),c("div",M,[a[10]||(a[10]=c("label",null,"商品标题",-1)),y(c("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>le.title=e),type:"text",placeholder:"请输入商品标题",required:""},null,512),[[h,le.title]])]),c("div",E,[c("div",H,[a[12]||(a[12]=c("label",null,"价格",-1)),c("div",J,[a[11]||(a[11]=c("span",{class:"price-symbol"},"¥",-1)),y(c("input",{"onUpdate:modelValue":a[2]||(a[2]=e=>le.price=e),type:"number",min:"0",step:"0.01",placeholder:"0.00",required:""},null,512),[[h,le.price,void 0,{number:!0}]])])]),c("div",N,[a[14]||(a[14]=c("label",null,"分类",-1)),y(c("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>le.categoryId=e),required:""},[...a[13]||(a[13]=[c("option",{value:"",disabled:""},"请选择分类",-1),c("option",{value:1},"电子产品",-1),c("option",{value:2},"书籍教材",-1),c("option",{value:3},"生活用品",-1),c("option",{value:4},"服饰鞋包",-1),c("option",{value:5},"其他",-1)])],512),[[b,le.categoryId]])])]),c("div",O,[a[15]||(a[15]=c("label",null,"商品描述",-1)),y(c("textarea",{"onUpdate:modelValue":a[4]||(a[4]=e=>le.description=e),rows:"4",placeholder:"请描述商品详情、成色、购买时间等",required:""},null,512),[[h,le.description]])])]),c("button",{type:"submit",class:"btn-submit",disabled:R.value||0===X.value.length},[R.value?(u(),o("span",$)):(u(),o("span",G,p(ee.value?"保存修改":"发布商品"),1))],8,P)],32)])]))}},[["__scopeId","data-v-2bd69eb9"]]);export{K as default};
