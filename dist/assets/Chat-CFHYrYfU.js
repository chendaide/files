import{_ as a,m as e,r as s,G as t,n,E as l,p as r,q as i,s as u,c as d,o as c,b as o,x as v,F as m,z as g,t as f,e as p,v as h,y,g as b,H as C,I,J as w,B as S}from"./index-DgsTEpUf.js";import{r as k}from"./request-DczqgLPf.js";import{g as M}from"./user-BBBixgcQ.js";function $(a,e,s){return k.get(`/chat/history/${a}`,{params:{currentUserId:e,afterTime:s}})}const N={class:"chat-page"},_={class:"navbar"},x={class:"nav-container"},D={class:"main-content"},q={class:"contact-list"},J=["onClick"],z=["src"],E={class:"contact-info"},H={class:"contact-name"},O={class:"contact-preview"},T={key:0,class:"unread-badge"},j={key:0,class:"empty-contacts"},B={class:"chat-window"},U={class:"chat-header"},F={class:"message-bubble"},G={class:"message-time"},K={key:0,class:"empty-messages"},L={class:"message-input"},R=["disabled"],V={key:1,class:"no-chat"},A=a({__name:"Chat",setup(a){const k=b(),A=e(()=>JSON.parse(localStorage.getItem("userInfo")||"{}")),P=s([]),Q=s(null),W=s([]),X=s(""),Y=s(null),Z=()=>`chatContacts_${A.value.id}`,aa=a=>JSON.parse(localStorage.getItem(`chatDeleteTimes_${A.value.id}`)||"{}")[a]||"",ea=()=>{const a=P.value.map(a=>({id:a.id,username:a.username,avatar:a.avatar,lastMessage:a.lastMessage,unreadCount:a.unreadCount||0}));localStorage.setItem(Z(),JSON.stringify(a))},sa=a=>{var e;const s=a.senderId===A.value.id,t=s?a.receiverId:a.senderId,n=P.value.find(a=>a.id===t);n?(n.lastMessage=a.content,s||(null==(e=Q.value)?void 0:e.id)===a.senderId||(n.unreadCount=(n.unreadCount||0)+1),ea()):s||ta(a.senderId,a.content),!Q.value||a.senderId!==Q.value.id&&a.receiverId!==Q.value.id||W.value.some(e=>e.id===a.id)||(W.value.push(a),ia())},ta=async(a,e)=>{try{const s=await M(a);P.value.unshift({...s.data,lastMessage:e,unreadCount:1}),ea()}catch(s){}},na=()=>{X.value.trim()&&Q.value&&(C()?(I(Q.value.id,X.value.trim()),X.value=""):l.error("连接已断开"))},la=async a=>{Q.value=a,a.unreadCount=0,await ra(),ea()},ra=async()=>{if(!Q.value)return;const a=await $(Q.value.id,A.value.id,aa(Q.value.id));W.value=a.data||[],W.value.length>0&&(Q.value.lastMessage=W.value[W.value.length-1].content,ea()),ia()},ia=()=>{w(()=>{Y.value&&(Y.value.scrollTop=Y.value.scrollHeight)})},ua=a=>{if(!a)return"";const e=new Date(a),s=new Date;return e.toDateString()===s.toDateString()?`${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`:`${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`},da=async()=>{let a=JSON.parse(localStorage.getItem(Z())||"[]");a=a.filter(a=>a.id!==A.value.id);const e=k.query.userId;if(e&&Number(e)!==A.value.id&&!a.find(a=>a.id===Number(e)))try{const s=await M(e);a.unshift({id:s.data.id,username:s.data.username,avatar:s.data.avatar,lastMessage:"",unreadCount:0})}catch(s){}for(const t of a)try{const a=await $(t.id,A.value.id,aa(t.id));a.data&&a.data.length&&(t.lastMessage=a.data[a.data.length-1].content)}catch(s){}if(P.value=a,ea(),e){const a=P.value.find(a=>a.id===Number(e));a&&la(a)}};return t(()=>k.query.userId,a=>{if(a){const e=P.value.find(e=>e.id===Number(a));e?la(e):da()}}),n(()=>{A.value.id?(r(sa),da()):l.error("请先登录")}),i(()=>{u(sa),ea()}),(a,e)=>(c(),d("div",N,[o("nav",_,[o("div",x,[o("button",{class:"btn-back",onClick:e[0]||(e[0]=e=>a.$router.back())},"返回"),e[2]||(e[2]=o("div",{class:"nav-brand"},"私信",-1))])]),o("main",D,[o("aside",q,[e[3]||(e[3]=o("div",{class:"contact-header"},"联系人",-1)),(c(!0),d(m,null,g(P.value,a=>{var e;return c(),d("div",{key:a.id,class:S(["contact-item",{active:(null==(e=Q.value)?void 0:e.id)===a.id}]),onClick:e=>la(a)},[o("img",{src:a.avatar||'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2386868b"%3E%3Cpath d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/%3E%3C/svg%3E',class:"contact-avatar"},null,8,z),o("div",E,[o("div",H,f(a.username),1),o("div",O,f(a.lastMessage||"暂无消息"),1)]),a.unreadCount?(c(),d("span",T,f(a.unreadCount),1)):v("",!0)],10,J)}),128)),P.value.length?v("",!0):(c(),d("div",j,"暂无联系人"))]),o("section",B,[Q.value?(c(),d(m,{key:0},[o("div",U,f(Q.value.username),1),o("div",{class:"message-list",ref_key:"messageListRef",ref:Y},[(c(!0),d(m,null,g(W.value,a=>(c(),d("div",{key:a.id,class:S(["message-item",{self:a.senderId===A.value.id}])},[o("div",F,f(a.content),1),o("div",G,f(ua(a.createTime)),1)],2))),128)),W.value.length?v("",!0):(c(),d("div",K,"开始聊天吧"))],512),o("div",L,[p(o("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>X.value=a),placeholder:"输入消息...",onKeyup:y(na,["enter"])},null,544),[[h,X.value]]),o("button",{class:"btn-send",onClick:na,disabled:!X.value.trim()}," 发送 ",8,R)])],64)):(c(),d("div",V,"选择一个联系人开始聊天"))])])]))}},[["__scopeId","data-v-3f9d4582"]]);export{A as default};
